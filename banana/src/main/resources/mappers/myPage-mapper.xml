<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace = "myPageMapper">

<resultMap type="GoodsSell" id="goodsSell_rm">
   	
   		<!-- DB에서 PK에 해당하는 필드, 컬럼을 작성하는 태그이다........ -->
   		<id property = "goodsNo" column = "GOODS_NO" />
   		
   		<!-- 나머지 일반 컬럼...!!!! -->
   			<result property="sellerNo" column="SELLER_NO" />
   			<result property="buyerNo" column="BUYER_NO" />
			<result property="categoryNo" column="CATEGORY_NO" />
			<result property="categoryName" column="CATEGORY_NAME" />
			<result property="title" column="TITLE" />
			<result property="sellPrice" column="SELL_PRICE" />
			<result property="viewCount" column="VIEW_COUNT" />
			<result property="description" column="DESCRIPTION" />
			<result property="refreshedAt" column="REFRESHED_AT" />
			<result property="createdAt" column="CREATED_AT" />
			<result property="goodsDelFlag" column="GOODS_DEL_FL" />
			<result property="sellStatus" column="SELL_STATUS" />
			<result property="imageNo" column="IMAGE_NO" />
			<result property="imagePath" column="IMAGE_PATH" />
			<result property="likeCount" column="LIKE_COUNT" />
			<result property="orderNo" column="ORDER_NO" />
			<result property="ratingNo" column="RATING_NO" />
			<result property="sellerNickname" column="SELLER_NICKNAME" />
			<result property="buyerNickname" column="BUYER_NICKNAME" />
			
			<!-- 없는 애도 있을 텐데 (ex)MEMBER_DEL_FL 그럼 걔는 걍 안담겨서 null로 나옴... -->
</resultMap>

<select id="selectGoodsSoldList" resultMap = "goodsSell_rm">
	SELECT G.GOODS_NO, SELLER_NO, TITLE,
	<![CDATA[
	CASE  WHEN SYSDATE - G.CREATED_AT < 1/24/60
	      THEN FLOOR( (SYSDATE - G.CREATED_AT) * 24 * 60 * 60 ) || '초 전'
	      WHEN SYSDATE - G.CREATED_AT < 1/24
	      THEN FLOOR( (SYSDATE - G.CREATED_AT) * 24 * 60) || '분 전'
	      WHEN SYSDATE - G.CREATED_AT < 1
	      THEN FLOOR( (SYSDATE - G.CREATED_AT) * 24) || '시간 전'
	      WHEN SYSDATE - G.CREATED_AT < 30
	      THEN FLOOR( (SYSDATE - G.CREATED_AT)  ) || '일 전'
	      ELSE TO_CHAR(G.CREATED_AT, 'YYYY-MM-DD')
	   END CREATED_AT, ]]> RATING_NO,
	(SELECT MEMBER_NICKNAME FROM "MEMBER" WHERE MEMBER_NO = BUYER_NO) BUYER_NICKNAME, IMAGE_NO, IMAGE_PATH
	FROM GOODS_SELL G
	LEFT JOIN REVIEW R ON(G.GOODS_NO = R.GOODS_NO)
	LEFT JOIN "MEMBER" M ON (M.MEMBER_NO = G.SELLER_NO)
	LEFT JOIN "GOODS_IMAGE" I ON(G.GOODS_NO = I.GOODS_NO)
	WHERE GOODS_DEL_FL = 'N' AND SELLER_NO = #{memberNo}
	AND (RECEIVER_NO != SELLER_NO  OR RECEIVER_NO IS NULL)
	AND BUYER_NO IS NOT NULL
</select>
  
 <update id="changeIntroduce">
  UPDATE "MEMBER" SET INTRODUCE = #{introduce}
	WHERE MEMBER_NO = #{memberNo}
</update>

 <!-- 내 회원 정보 수정 (비밀번호 포함) -->
 <update id="updateInfoPw" parameterType="Member">
	 	UPDATE "MEMBER" SET
		MEMBER_NICKNAME = #{memberNickname},
		MEMBER_TEL= #{memberTel},
		MEMBER_ADDRESS = #{memberAddress},
		MEMBER_PW = #{memberPw}
		WHERE MEMBER_NO = #{memberNo}
</update>


<select id = "getListCount" parameterType = "_int" resultType = "_int">
	SELECT COUNT(*) FROM(
	SELECT RATING_NO 
	FROM GOODS_SELL 
	LEFT JOIN REVIEW  USING(GOODS_NO)
	WHERE GOODS_DEL_FL = 'N' AND SELLER_NO = #{memberNo}
	AND (RECEIVER_NO != SELLER_NO  OR RECEIVER_NO IS NULL)
	AND BUYER_NO IS NOT NULL)
</select>


 <!-- 내 회원 정보 수정 (비밀번호 제외) -->
 <update id="updateInfoNoPw" parameterType="Member">
	 	UPDATE "MEMBER" SET
		MEMBER_NICKNAME = #{memberNickname},
		MEMBER_TEL= #{memberTel},
		MEMBER_ADDRESS = #{memberAddress}
		WHERE MEMBER_NO = #{memberNo}
</update>


</mapper>
