<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace = "goodsMapper">
  
  
  	<resultMap type="GoodsSell" id="goods_rm">
   
   		<id property="goodsNo" column="GOODS_NO"/>
   		
   		<result property="sellerNo" column="SELLER_NO"></result>
   		<result property="categoryNo" column="CATEGORY_NO"></result>
   		<result property="title" column="TITLE"></result>
   		<result property="sellPrice" column="SELL_PRICE"></result>
   		<result property="viewCount" column="VIEW_COUNT"></result>
   		<result property="description" column="DESCRIPTION"></result>
   		<result property="refreshedAt" column="REFRESHRED_AT"></result>
   		<result property="createdAt" column="CREATED_AT"></result>
   		<result property="goodsDelFlag" column="GOODS_DEL_FL"></result>
   		<result property="imageNo" column="IMAGE_NO"></result>
   		<result property="imagePath" column="IMAGE_PATH"></result>
   		<result property="orderNo" column="ORDER_NO"></result>
   		
   		<result property="thumbnail" column="THUMBNAIL"></result>
   		<result property="isLike" column="IS_LIKE"></result>
   		

   		
   		
 	</resultMap>
 	 
 	 
	<resultMap type="GoodsImage" id="goodsImage_rm">
		<id property="goodsNo" column="GOODS_NO"/>
   		
   		<result property="imageNo" column="IMAGE_NO"></result>
   		<result property="imagePath" column="IMAGE_PATH"></result>
   		<result property="ImageOrder" column="IMG_ORDER"></result>
	</resultMap>
	
	
	

 	 
 	 
 	 <!-- 상품등록 -->
 	 <insert id="registerGoods" parameterType="GoodsSell">
 	 	INSERT INTO GOODS_SELL	
		VALUES(SEQ_GOODS_NO.NEXTVAL, #{sellerNo}, NULL, #{categoryNo}, #{title}, 
		#{sellPrice}, DEFAULT, #{description}, NULL, DEFAULT, DEFAULT)
 	 </insert>
 	 
 	 
 	 <!-- 방금 등록된 상품번호 조회 -->
 	 <select id="selectMyGoods" resultType="_int">
 	 	SELECT GOODS_NO FROM(
		SELECT GOODS_NO FROM GOODS_SELL
		ORDER BY CREATED_AT DESC)
		WHERE ROWNUM <![CDATA[<= 1]]>
 	 </select>
 	 
 	 
 	 <!-- registerImage -->
 	 <insert id="registerImage" parameterType="GoodsImage">
 	 	INSERT INTO GOODS_IMAGE
 	 	VALUES(SEQ_IMAGE_NO.NEXTVAL, #{goodsNo}, #{imagePath}, #{imageOrder})
 	 </insert>
 	 
 	 
 	 <select id="selectList">
 	 	SELECT * FROM GOODS_SELL
		WHERE GOODS_DEL_FL = 'N' AND (BUYER_NO IS NULL)
		ORDER BY VIEW_COUNT DESC, REFRESHED_AT DESC, CREATED_AT DESC
 	 </select>
 	 
 	 
 	 <select id="selectGoods" parameterType="_int" resultType="GoodsSell">
 	 	SELECT * FROM GOODS_SELL
 	 	WHERE GOODS_NO = #{goodsNo}
 	 </select>
  





	<!-- 메인페이지 인기상품 + goods에 좋아요 누른여부, 썸네일 -->
	<select id="favoriteGoods" resultMap="goods_rm">
		SELECT GOODS_NO, SELLER_NO, BUYER_NO, CATEGORY_NO, TITLE, 
		SELL_PRICE, VIEW_COUNT, DESCRIPTION, REFRESHED_AT, CREATED_AT, GOODS_DEL_FL, 		
		(SELECT COUNT(*) FROM GOODS_LIKE GL
			WHERE (GL.GOODS_NO = G.GOODS_NO)
			AND (MEMBER_NO = #{memberNo})) IS_LIKE,			
		(SELECT IMAGE_PATH  FROM GOODS_IMAGE GI
		WHERE (G.GOODS_NO = GI.GOODS_NO)
		AND IMG_ORDER = 0) THUMBNAIL
		FROM
		 (SELECT  
		 	CASE  <![CDATA[
			      WHEN SYSDATE - CREATED_AT < 1/24/60
			      THEN FLOOR( (SYSDATE - CREATED_AT) * 24 * 60 * 60 ) || '초 전'
			      WHEN SYSDATE - CREATED_AT < 1/24
			      THEN FLOOR( (SYSDATE - CREATED_AT) * 24 * 60) || '분 전'
			      WHEN SYSDATE - CREATED_AT < 1
			      THEN FLOOR( (SYSDATE - CREATED_AT) * 24) || '시간 전'
			      ELSE TO_CHAR(CREATED_AT, 'YYYY-MM-DD')
			   		END CREATED_AT, ]]>
			CASE  <![CDATA[
			      WHEN SYSDATE - REFRESHED_AT < 1/24/60
			      THEN FLOOR( (SYSDATE - REFRESHED_AT) * 24 * 60 * 60 ) || '초 전'
			      WHEN SYSDATE - REFRESHED_AT < 1/24
			      THEN FLOOR( (SYSDATE - REFRESHED_AT) * 24 * 60) || '분 전'
			      WHEN SYSDATE - REFRESHED_AT < 1
			      THEN FLOOR( (SYSDATE - REFRESHED_AT) * 24) || '시간 전'
			      ELSE TO_CHAR(REFRESHED_AT, 'YYYY-MM-DD')
			   		END REFRESHED_AT, ]]>
   			GOODS_NO, SELLER_NO, BUYER_NO, CATEGORY_NO, TITLE, 
			SELL_PRICE, VIEW_COUNT, DESCRIPTION, GOODS_DEL_FL
		 		FROM GOODS_SELL S
		 		ORDER BY  VIEW_COUNT DESC) G
 		<![CDATA[ WHERE ROWNUM <= 5 ]]>
	</select>
	
	
	<!-- 메인페이지 최근상품 + goods에 좋아요 누른여부, 썸네일 -->
	<select id="newGoods" parameterType="_int" resultMap="goods_rm">
		SELECT GOODS_NO, SELLER_NO, BUYER_NO, CATEGORY_NO, TITLE, 
		SELL_PRICE, VIEW_COUNT, DESCRIPTION, REFRESHED_AT, CREATED_AT, GOODS_DEL_FL, 
		(SELECT COUNT(*) FROM GOODS_LIKE GL
			WHERE (GL.GOODS_NO = G.GOODS_NO)
			AND (MEMBER_NO = #{memberNo})) IS_LIKE,		
		(SELECT IMAGE_PATH  FROM GOODS_IMAGE GI
		WHERE (G.GOODS_NO = GI.GOODS_NO)
		AND IMG_ORDER = 0) THUMBNAIL
		FROM
		 (SELECT  
		 	CASE  <![CDATA[
			      WHEN SYSDATE - CREATED_AT < 1/24/60
			      THEN FLOOR( (SYSDATE - CREATED_AT) * 24 * 60 * 60 ) || '초 전'
			      WHEN SYSDATE - CREATED_AT < 1/24
			      THEN FLOOR( (SYSDATE - CREATED_AT) * 24 * 60) || '분 전'
			      WHEN SYSDATE - CREATED_AT < 1
			      THEN FLOOR( (SYSDATE - CREATED_AT) * 24) || '시간 전'
			      ELSE TO_CHAR(CREATED_AT, 'YYYY-MM-DD')
			   		END CREATED_AT, ]]>
			CASE  <![CDATA[
			      WHEN SYSDATE - REFRESHED_AT < 1/24/60
			      THEN FLOOR( (SYSDATE - REFRESHED_AT) * 24 * 60 * 60 ) || '초 전'
			      WHEN SYSDATE - REFRESHED_AT < 1/24
			      THEN FLOOR( (SYSDATE - REFRESHED_AT) * 24 * 60) || '분 전'
			      WHEN SYSDATE - REFRESHED_AT < 1
			      THEN FLOOR( (SYSDATE - REFRESHED_AT) * 24) || '시간 전'
			      ELSE TO_CHAR(REFRESHED_AT, 'YYYY-MM-DD')
			   		END REFRESHED_AT, ]]>
   			GOODS_NO, SELLER_NO, BUYER_NO, CATEGORY_NO, TITLE, 
			SELL_PRICE, VIEW_COUNT, DESCRIPTION, GOODS_DEL_FL
		 		FROM GOODS_SELL S
		 		ORDER BY GOODS_NO DESC) G
 		<![CDATA[ WHERE ROWNUM <= 5 ]]>
	</select>
	
	
	<!-- 좋아요 수 증가 -->
	<delete id="goodsLikeDown" parameterType="map">
		DELETE FROM GOODS_LIKE 
		WHERE BOARD_NO = #{boardNo}
		AND MEMBER_ = #{memberNo}
	</delete>
  
  

  
</mapper>
